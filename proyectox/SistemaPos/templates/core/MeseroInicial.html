{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sala {{ sala.nombre }}</title>
  <link rel="stylesheet" href="{% static 'styles/sala.css' %}">
  <style>
    /* Estilos b√°sicos */
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      width: 250px;
      background-color: #333;
      color: white;
      padding: 20px;
      height: 100vh;
    }
    #sidebar .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    #sidebar ul {
      list-style-type: none;
      padding: 0;
    }
    #sidebar li {
      margin-bottom: 10px;
    }
    #sidebar a {
      color: white;
      text-decoration: none;
    }
    main {
      flex-grow: 1;
      padding: 20px;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .mesa-btn {
      width: 100px;
      height: 100px;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
    }
    .mesa-btn.libre { background-color: green; color: white; }
    .mesa-btn.ocupada { background-color: red; color: white; }
    .mesa-btn.servicio { background-color: orange; color: white; }

    #modalPedido {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      display: flex;
      width: 80%;
      max-height: 90%;
      overflow-y: auto;
      border-radius: 10px;
      gap: 20px;
    }
    .close-btn {
      float: right;
      background-color: red;
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .producto {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      border-radius: 5px;
    }
    .producto img {
      width: 100px;
      height: 100px;
    }
    .categorias button {
      margin: 5px;
    }
    .pedido-detalle {
      min-width: 300px;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav id="sidebar">
    <div class="logo">
      <img src="{% static 'icons/home.png' %}" alt="Logo" style="width: 100%;">
    </div>
    <ul>
      {% for s in salas %}
        <li class="room">
          <a href="{% url 'vista_sala' s.id %}">Sala {{ s.nombre }}</a>
          <ul>
            {% for m in s.mesa_set.all %}
              <li style="font-size: 12px;">Mesa {{ m.numero }}</li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
    </ul>
    <br>
    <a href="#" style="color: white;">Salir</a>
  </nav>

  <!-- Main -->
  <main>
    <h1>SALA {{ sala.nombre }}</h1>

    <div class="grid">
      {% for mesa in sala.mesa_set.all %}
      <button
        class="mesa-btn {{ mesa.estado }}"
        onclick="abrirModal({{ mesa.id }}, '{{ mesa.numero|escapejs }}')">
        MESA {{ mesa.numero }}
      </button>
      {% endfor %}
    </div>
  </main>

  <!-- Modal -->
  <div id="modalPedido">
    <div class="modal-content">
      <div style="flex-grow:1;">
        <button class="close-btn" onclick="cerrarModal()">X</button>
        <h2>Pedido - Mesa <span id="mesaNumero"></span></h2>

        <div class="categorias">
          {% for categoria in categorias %}
          <button onclick="filtrarCategoria('{{ categoria.id }}')">{{ categoria.nombre }}</button>
          {% endfor %}
        </div>

        <div class="productos" id="productos">
          {% for producto in productos %}
          <div class="producto" data-categoria="{{ producto.categoria.id }}">
            <img src="{% static 'img/comida.jpg' %}" alt="{{ producto.nombre }}">
            <p>{{ producto.nombre }}</p>
            <p>${{ producto.precio }}</p>
            <button 
              class="agregar-btn"
              data-id="{{ producto.id }}"
              data-nombre="{{ producto.nombre|escapejs }}"
              data-precio="{{ producto.precio }}"
              onclick="handleAgregarProducto(this)">
              Agregar
            </button>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="pedido-detalle">
        <h3>Pedido</h3>
        <ul id="listaPedido"></ul>
        <p>Total: $<span id="totalPedido">0</span></p>
        <button onclick="enviarPedido()">Pedir</button>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    let mesaSeleccionada = null;
    let pedido = [];

    function abrirModal(id, numero) {
      mesaSeleccionada = id;
      pedido = [];
      document.getElementById('mesaNumero').textContent = numero;
      document.getElementById('listaPedido').innerHTML = '';
      document.getElementById('totalPedido').textContent = '0';
      document.getElementById('modalPedido').style.display = 'flex';
    }

    function cerrarModal() {
      document.getElementById('modalPedido').style.display = 'none';
    }

    function handleAgregarProducto(btn) {
      const id = parseInt(btn.dataset.id);
      const nombre = btn.dataset.nombre;
      const precio = parseFloat(btn.dataset.precio);
      agregarProducto(id, nombre, precio);
    }

    function agregarProducto(id, nombre, precio) {
      pedido.push({ id, nombre, precio });
      actualizarPedido();
    }

    function actualizarPedido() {
      const lista = document.getElementById('listaPedido');
      lista.innerHTML = '';
      let total = 0;

      pedido.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.nombre} - $${p.precio.toFixed(2)}`;
        lista.appendChild(li);
        total += p.precio;
      });

      document.getElementById('totalPedido').textContent = total.toFixed(2);
    }

    function enviarPedido() {
      fetch('{% url "crear_pedido" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          mesa_id: mesaSeleccionada,
          productos: pedido
        })
      }).then(res => {
        if (res.ok) {
          cerrarModal();
          location.reload();
        }
      });
    }

    function filtrarCategoria(catId) {
      document.querySelectorAll('.producto').forEach(p => {
        if (p.getAttribute('data-categoria') === catId) {
          p.style.display = 'block';
        } else {
          p.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
